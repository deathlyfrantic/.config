#!/usr/bin/env python3
import requests
import sys
from urllib import parse

# https://developer.yahoo.com/weather/
URL = 'https://query.yahooapis.com/v1/public/yql?q=select%20item.condition%20from%20weather.forecast%20where%20woeid%20in%20(select%20woeid%20from%20geo.places(1)%20where%20text%3D%22{}%22)&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys'

def get_weather(location):
    req = requests.get(URL.format(parse.quote(location)))
    response = req.json()

    try:
        conditions = response['query']['results']['channel']['item']['condition']
        temp = conditions['temp']
        desc = conditions['text']
        return f'{temp}Â° and {desc}'
    except:
        return None

if __name__ == '__main__':
    try:
        location = sys.argv[1]
    except IndexError:
        print(f'Usage: `{sys.argv[0]} <location>` where <location> is recognizable by the Yahoo Weather API.')
        exit()

    try:
        attempts = int(sys.argv[2])
    except:
        attempts = 5

    count = 0
    while True:
        weather = get_weather(location)

        if weather is not None:
            break
        elif count >= attempts:
            weather = f'Failed to retrieve weather after {count} attempts.'
            break

        count += 1

    print(weather)
